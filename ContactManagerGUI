// ContactManagerGUI.java
import javax.swing.*;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.awt.event.*;

public class ContactManagerGUI extends JFrame {
    private final ContactManager manager;
    private final DefaultTableModel tableModel;
    private final JTable table;
    private final String[] columns = {"Name", "Phone", "Email"};
    private final JLabel statusLabel = new JLabel(" ");

    public ContactManagerGUI(String persistencePath) {
        super("Contact Manager");
        this.manager = new ContactManager(persistencePath);

        // Table model (non-editable cells directly)
        tableModel = new DefaultTableModel(columns, 0) {
            @Override public boolean isCellEditable(int row, int column) { return false; }
        };
        table = new JTable(tableModel);
        table.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);

        initUI();
        loadContactsOnStart();

        // save on close
        addWindowListener(new WindowAdapter() {
            @Override
            public void windowClosing(WindowEvent e) {
                try {
                    manager.save();
                } catch (Exception ex) {
                    ex.printStackTrace();
                }
                dispose();
                System.exit(0);
            }
        });

        setSize(760, 480);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(DO_NOTHING_ON_CLOSE); // handled above
    }

    private void initUI() {
        JPanel topPanel = new JPanel(new BorderLayout(8, 8));
        topPanel.setBorder(BorderFactory.createEmptyBorder(8,8,8,8));

        // Buttons
        JPanel btnPanel = new JPanel(new FlowLayout(FlowLayout.LEFT));
        JButton addBtn = new JButton("Add");
        JButton editBtn = new JButton("Edit");
        JButton delBtn = new JButton("Delete");
        JButton refreshBtn = new JButton("Refresh");
        JButton exportBtn = new JButton("Export CSV");

        btnPanel.add(addBtn);
        btnPanel.add(editBtn);
        btnPanel.add(delBtn);
        btnPanel.add(refreshBtn);
        btnPanel.add(exportBtn);

        // Search
        JPanel searchPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        JTextField searchField = new JTextField(20);
        JButton searchBtn = new JButton("Search");
        JButton clearSearchBtn = new JButton("Clear");
        searchPanel.add(new JLabel("Filter: "));
        searchPanel.add(searchField);
        searchPanel.add(searchBtn);
        searchPanel.add(clearSearchBtn);

        topPanel.add(btnPanel, BorderLayout.WEST);
        topPanel.add(searchPanel, BorderLayout.EAST);

        // Table scroll
        JScrollPane scroll = new JScrollPane(table);

        // status bar
        JPanel bottom = new JPanel(new BorderLayout());
        bottom.setBorder(BorderFactory.createEmptyBorder(6,6,6,6));
        bottom.add(statusLabel, BorderLayout.WEST);

        // Layout
        getContentPane().setLayout(new BorderLayout());
        getContentPane().add(topPanel, BorderLayout.NORTH);
        getContentPane().add(scroll, BorderLayout.CENTER);
        getContentPane().add(bottom, BorderLayout.SOUTH);

        // Button actions
        addBtn.addActionListener(e -> onAdd());
        editBtn.addActionListener(e -> onEdit());
        delBtn.addActionListener(e -> onDelete());
        refreshBtn.addActionListener(e -> reloadTable());
        exportBtn.addActionListener(e -> onExport());

        searchBtn.addActionListener(e -> onSearch(searchField.getText().trim()));
        clearSearchBtn.addActionListener(e -> {
            searchField.setText("");
            reloadTable();
        });

        table.getSelectionModel().addListSelectionListener(e -> {
            int sel = table.getSelectedRow();
            statusLabel.setText(sel >= 0 ? "Selected: " + tableModel.getValueAt(sel, 0) : " ");
        });

        // double-click to edit
        table.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent e) {
                if (e.getClickCount() == 2) onEdit();
            }
        });
    }

    private void onAdd() {
        ContactFormDialog dlg = new ContactFormDialog(this, "Add Contact", null);
        dlg.setVisible(true);
        Contact c = dlg.getContact();
        if (c != null) {
            manager.add(c);
            reloadTable();
            setStatus("Added: " + c.getName());
        }
    }

    private void onEdit() {
        int sel = table.getSelectedRow();
        if (sel < 0) {
            JOptionPane.showMessageDialog(this, "Select a contact to edit.", "No selection", JOptionPane.WARNING_MESSAGE);
            return;
        }
        Contact existing = manager.getAll().get(sel);
        ContactFormDialog dlg = new ContactFormDialog(this, "Edit Contact", existing);
        dlg.setVisible(true);
        Contact updated = dlg.getContact();
        if (updated != null) {
            manager.update(sel, updated);
            reloadTable();
            setStatus("Updated: " + updated.getName());
        }
    }

    private void onDelete() {
        int sel = table.getSelectedRow();
        if (sel < 0) {
            JOptionPane.showMessageDialog(this, "Select a contact to delete.", "No selection", JOptionPane.WARNING_MESSAGE);
            return;
        }
        int confirm = JOptionPane.showConfirmDialog(this, "Delete selected contact?", "Confirm", JOptionPane.YES_NO_OPTION);
        if (confirm == JOptionPane.YES_OPTION) {
            String name = manager.getAll().get(sel).getName();
            manager.remove(sel);
            reloadTable();
            setStatus("Deleted: " + name);
        }
    }

    private void onExport() {
        JFileChooser fc = new JFileChooser();
        fc.setDialogTitle("Export contacts as CSV");
        int res = fc.showSaveDialog(this);
        if (res == JFileChooser.APPROVE_OPTION) {
            java.io.File out = fc.getSelectedFile();
            try {
                // reuse manager save logic to write full list
                try (java.io.BufferedWriter bw = new java.io.BufferedWriter(new java.io.OutputStreamWriter(new java.io.FileOutputStream(out), java.nio.charset.StandardCharsets.UTF_8))) {
                    for (Contact c : manager.getAll()) {
                        bw.write(c.toCSV());
                        bw.newLine();
                    }
                }
                JOptionPane.showMessageDialog(this, "Exported to " + out.getAbsolutePath());
            } catch (Exception ex) {
                ex.printStackTrace();
                JOptionPane.showMessageDialog(this, "Export failed: " + ex.getMessage(), "Error", JOptionPane.ERROR_MESSAGE);
            }
        }
    }

    private void onSearch(String term) {
        if (term == null || term.isEmpty()) {
            reloadTable();
            return;
        }
        DefaultTableModel tm = (DefaultTableModel) table.getModel();
        tm.setRowCount(0);
        String lower = term.toLowerCase();
        for (Contact c : manager.getAll()) {
            if (c.getName().toLowerCase().contains(lower) ||
                c.getPhone().toLowerCase().contains(lower) ||
                c.getEmail().toLowerCase().contains(lower)) {
                tm.addRow(new Object[]{c.getName(), c.getPhone(), c.getEmail()});
            }
        }
        setStatus("Filtered: \"" + term + "\"");
    }

    private void loadContactsOnStart() {
        try {
            manager.load();
        } catch (Exception ex) {
            ex.printStackTrace();
            JOptionPane.showMessageDialog(this, "Failed to load contacts: " + ex.getMessage(), "Warning", JOptionPane.WARNING_MESSAGE);
        }
        reloadTable();
    }

    private void reloadTable() {
        DefaultTableModel tm = tableModel;
        tm.setRowCount(0);
        for (Contact c : manager.getAll()) {
            tm.addRow(new Object[]{c.getName(), c.getPhone(), c.getEmail()});
        }
        setStatus("Contacts: " + manager.size());
    }

    private void setStatus(String text) {
        statusLabel.setText(text);
    }

    // --- Contact form dialog ---
    private static class ContactFormDialog extends JDialog {
        private Contact contact = null;
        private final JTextField nameField = new JTextField(30);
        private final JTextField phoneField = new JTextField(20);
        private final JTextField emailField = new JTextField(30);

        public ContactFormDialog(Frame owner, String title, Contact existing) {
            super(owner, title, true);
            JPanel p = new JPanel(new GridBagLayout());
            GridBagConstraints gbc = new GridBagConstraints();
            gbc.insets = new Insets(6,6,6,6);
            gbc.anchor = GridBagConstraints.WEST;

            gbc.gridx = 0; gbc.gridy = 0; p.add(new JLabel("Name:"), gbc);
            gbc.gridx = 1; gbc.gridy = 0; p.add(nameField, gbc);

            gbc.gridx = 0; gbc.gridy = 1; p.add(new JLabel("Phone:"), gbc);
            gbc.gridx = 1; gbc.gridy = 1; p.add(phoneField, gbc);

            gbc.gridx = 0; gbc.gridy = 2; p.add(new JLabel("Email:"), gbc);
            gbc.gridx = 1; gbc.gridy = 2; p.add(emailField, gbc);

            if (existing != null) {
                nameField.setText(existing.getName());
                phoneField.setText(existing.getPhone());
                emailField.setText(existing.getEmail());
            }

            JButton ok = new JButton("OK");
            JButton cancel = new JButton("Cancel");
            JPanel btns = new JPanel(new FlowLayout(FlowLayout.RIGHT));
            btns.add(ok);
            btns.add(cancel);

            ok.addActionListener(e -> {
                String n = nameField.getText().trim();
                String ph = phoneField.getText().trim();
                String em = emailField.getText().trim();

                if (n.isEmpty()) {
                    JOptionPane.showMessageDialog(this, "Name is required.", "Validation", JOptionPane.WARNING_MESSAGE);
                    return;
                }
                contact = new Contact(n, ph, em);
                setVisible(false);
                dispose();
            });

            cancel.addActionListener(e -> {
                contact = null;
                setVisible(false);
                dispose();
            });

            getContentPane().add(p, BorderLayout.CENTER);
            getContentPane().add(btns, BorderLayout.SOUTH);
            pack();
            setLocationRelativeTo(owner);
        }

        public Contact getContact() {
            return contact;
        }
    }

    // --- main ---
    public static void main(String[] args) {
        String persistence = System.getProperty("user.home") + System.getProperty("file.separator") + "contacts.csv";
        if (args.length > 0) persistence = args[0];

        final String finalPersistence = persistence;
        SwingUtilities.invokeLater(() -> {
            ContactManagerGUI gui = new ContactManagerGUI(finalPersistence);
            gui.setVisible(true);
        });
    }
}
